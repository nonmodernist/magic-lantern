<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Magic Lantern Review Interface</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .score {
            background: #4CAF50;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
        }
        .excerpt {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
            font-size: 14px;
            line-height: 1.5;
        }
        .actions {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        .actions a {
            padding: 8px 16px;
            background: #2196F3;
            color: white;
            text-decoration: none;
            border-radius: 4px;
        }
        .tags {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        .tag-btn {
            padding: 6px 12px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
        }
        .tag-btn.active {
            background: #E3F2FD;
            border-color: #2196F3;
        }
        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nav button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        .progress {
            background: #e0e0e0;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-bar {
            background: #4CAF50;
            height: 100%;
            transition: width 0.3s;
        }
        .status {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        .status button {
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .reviewed {
            background: #C8E6C9;
        }
        .important {
            background: #FFF9C4;
        }
        .note-input {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>üîç Magic Lantern Review Interface</h1>
    
    <div class="card">
        <input type="file" id="fileInput" accept=".json">
        <button onclick="loadSampleData()">Load Sample Data</button>
    </div>

    <div id="mainInterface" style="display: none;">
        <div class="card">
            <h2 id="filmTitle">Film Title</h2>
            <div class="progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <p id="progressText">0 / 0 reviewed</p>
        </div>

        <div class="card" id="resultCard">
            <div class="header">
                <h3 id="resultTitle">Loading...</h3>
                <span class="score" id="resultScore">0</span>
            </div>
            
            <div class="excerpt" id="resultExcerpt">Loading...</div>
            
            <div class="actions">
                <a id="lanternLink" href="#" target="_blank">üëÅÔ∏è View in Lantern</a>
                <a id="iaLink" href="#" target="_blank">üìñ View in IA</a>
            </div>
            
            <div class="tags" id="tagButtons">
                <button class="tag-btn" onclick="toggleTag('review')">Review</button>
                <button class="tag-btn" onclick="toggleTag('production')">Production</button>
                <button class="tag-btn" onclick="toggleTag('box_office')">Box Office</button>
                <button class="tag-btn" onclick="toggleTag('advertisement')">Ad</button>
                <button class="tag-btn" onclick="toggleTag('has_photo')">Has Photo</button>
                <button class="tag-btn" onclick="toggleTag('labor_mention')">Labor Mention</button>
            </div>
            
            <input type="text" class="note-input" id="noteInput" placeholder="Add a note...">
            
            <div class="status">
                <button id="reviewedBtn" onclick="toggleReviewed()">‚úì Mark Reviewed</button>
                <button id="importantBtn" onclick="toggleImportant()">‚≠ê Important</button>
                <button onclick="toggleSkip()">üö´ Skip</button>
            </div>
        </div>

        <div class="card nav">
            <button onclick="previousResult()">‚Üê Previous</button>
            <span id="navText">1 / 1</span>
            <button onclick="nextResult()">Next ‚Üí</button>
        </div>

        <div class="card">
            <button onclick="exportProgress()">üì• Export Progress</button>
            <button onclick="jumpToUnreviewed()">‚è≠Ô∏è Jump to Unreviewed</button>
            <button onclick="showStats()">üìä Show Stats</button>
        </div>
    </div>

    <script>
        // Global state
        let currentData = null;
        let currentFilmIndex = 0;
        let currentResultIndex = 0;
        let reviewState = {};

        // Initialize or load review state from localStorage
        function loadReviewState() {
            const saved = localStorage.getItem('magicLanternReviews');
            if (saved) {
                reviewState = JSON.parse(saved);
            }
        }

        function saveReviewState() {
            localStorage.setItem('magicLanternReviews', JSON.stringify(reviewState));
        }

        // Load JSON file
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        currentData = JSON.parse(e.target.result);
                        initializeInterface();
                    } catch (err) {
                        alert('Error loading JSON file: ' + err.message);
                    }
                };
                reader.readAsText(file);
            }
        });

        // Get unique ID for a result
        function getResultId(filmIndex, resultIndex) {
            const film = currentData[filmIndex].film;
            const result = currentData[filmIndex].treasures[resultIndex];
            return `${film.title}_${film.year}_${result.id}`;
        }

        // Initialize interface with loaded data
        function initializeInterface() {
            loadReviewState();
            document.getElementById('mainInterface').style.display = 'block';
            displayCurrentResult();
            updateProgress();
        }

        // Display current result
        function displayCurrentResult() {
            const film = currentData[currentFilmIndex];
            const result = film.treasures[currentResultIndex];
            const resultId = getResultId(currentFilmIndex, currentResultIndex);
            const state = reviewState[resultId] || {};

            // Update film info
            document.getElementById('filmTitle').textContent = 
                `${film.film.title} (${film.film.year}) - ${film.totalFound} sources found`;

            // Update result info
            document.getElementById('resultTitle').textContent = 
                `${result.publication || 'Unknown'} - ${result.date || 'Date unknown'}`;
            document.getElementById('resultScore').textContent = 
                result.finalScore ? result.finalScore.toFixed(1) : '0';
            
            // Show excerpt or first part of full text
            const excerpt = result.excerpt || result.enhancedExcerpt || 
                           (result.fullText ? result.fullText.substring(0, 300) + '...' : 'No text available');
            document.getElementById('resultExcerpt').textContent = excerpt;

            // Update links
            const lanternUrl = `https://lantern.mediahist.org/catalog/${result.id}`;
            document.getElementById('lanternLink').href = lanternUrl;
            
            if (result.readUrl) {
                document.getElementById('iaLink').href = result.readUrl;
                document.getElementById('iaLink').style.display = 'inline-block';
            } else {
                document.getElementById('iaLink').style.display = 'none';
            }

            // Update UI state
            updateUIState(state);

            // Update navigation
            document.getElementById('navText').textContent = 
                `${currentResultIndex + 1} / ${film.treasures.length}`;
        }

        // Update UI based on saved state
        function updateUIState(state) {
            // Update tags
            document.querySelectorAll('.tag-btn').forEach(btn => {
                const tag = btn.textContent.toLowerCase().replace(/ /g, '_');
                btn.classList.toggle('active', state.tags && state.tags.includes(tag));
            });

            // Update status buttons
            document.getElementById('reviewedBtn').classList.toggle('reviewed', state.reviewed || false);
            document.getElementById('importantBtn').classList.toggle('important', state.important || false);

            // Update note
            document.getElementById('noteInput').value = state.note || '';
        }

        // Toggle tag
        function toggleTag(tag) {
            const resultId = getResultId(currentFilmIndex, currentResultIndex);
            if (!reviewState[resultId]) reviewState[resultId] = {};
            if (!reviewState[resultId].tags) reviewState[resultId].tags = [];
            
            const tags = reviewState[resultId].tags;
            const index = tags.indexOf(tag);
            if (index > -1) {
                tags.splice(index, 1);
            } else {
                tags.push(tag);
            }
            
            saveReviewState();
            displayCurrentResult();
        }

        // Toggle reviewed status
        function toggleReviewed() {
            const resultId = getResultId(currentFilmIndex, currentResultIndex);
            if (!reviewState[resultId]) reviewState[resultId] = {};
            reviewState[resultId].reviewed = !reviewState[resultId].reviewed;
            saveReviewState();
            displayCurrentResult();
            updateProgress();
        }

        // Toggle important status
        function toggleImportant() {
            const resultId = getResultId(currentFilmIndex, currentResultIndex);
            if (!reviewState[resultId]) reviewState[resultId] = {};
            reviewState[resultId].important = !reviewState[resultId].important;
            saveReviewState();
            displayCurrentResult();
        }

        // Toggle skip status
        function toggleSkip() {
            const resultId = getResultId(currentFilmIndex, currentResultIndex);
            if (!reviewState[resultId]) reviewState[resultId] = {};
            reviewState[resultId].skip = !reviewState[resultId].skip;
            reviewState[resultId].reviewed = true; // Mark as reviewed when skipped
            saveReviewState();
            nextResult();
        }

        // Save note
        document.getElementById('noteInput').addEventListener('blur', function() {
            const resultId = getResultId(currentFilmIndex, currentResultIndex);
            if (!reviewState[resultId]) reviewState[resultId] = {};
            reviewState[resultId].note = this.value;
            saveReviewState();
        });

        // Navigation
        function nextResult() {
            const film = currentData[currentFilmIndex];
            if (currentResultIndex < film.treasures.length - 1) {
                currentResultIndex++;
            } else if (currentFilmIndex < currentData.length - 1) {
                currentFilmIndex++;
                currentResultIndex = 0;
            }
            displayCurrentResult();
        }

        function previousResult() {
            if (currentResultIndex > 0) {
                currentResultIndex--;
            } else if (currentFilmIndex > 0) {
                currentFilmIndex--;
                currentResultIndex = currentData[currentFilmIndex].treasures.length - 1;
            }
            displayCurrentResult();
        }

        // Jump to unreviewed
        function jumpToUnreviewed() {
            for (let fi = 0; fi < currentData.length; fi++) {
                for (let ri = 0; ri < currentData[fi].treasures.length; ri++) {
                    const resultId = getResultId(fi, ri);
                    if (!reviewState[resultId] || !reviewState[resultId].reviewed) {
                        currentFilmIndex = fi;
                        currentResultIndex = ri;
                        displayCurrentResult();
                        return;
                    }
                }
            }
            alert('All results have been reviewed!');
        }

        // Update progress
        function updateProgress() {
            let totalResults = 0;
            let reviewedResults = 0;
            
            currentData.forEach((film, fi) => {
                film.treasures.forEach((result, ri) => {
                    totalResults++;
                    const resultId = getResultId(fi, ri);
                    if (reviewState[resultId] && reviewState[resultId].reviewed) {
                        reviewedResults++;
                    }
                });
            });
            
            const percentage = (reviewedResults / totalResults) * 100;
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('progressText').textContent = 
                `${reviewedResults} / ${totalResults} reviewed (${percentage.toFixed(1)}%)`;
        }

        // Export progress
        function exportProgress() {
            const exportData = {
                reviewState: reviewState,
                stats: calculateStats(),
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], 
                                  {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `magic-lantern-review-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        // Calculate statistics
        function calculateStats() {
            const stats = {
                totalFilms: currentData.length,
                totalResults: 0,
                reviewed: 0,
                important: 0,
                skipped: 0,
                tags: {}
            };
            
            currentData.forEach((film, fi) => {
                film.treasures.forEach((result, ri) => {
                    stats.totalResults++;
                    const resultId = getResultId(fi, ri);
                    const state = reviewState[resultId];
                    if (state) {
                        if (state.reviewed) stats.reviewed++;
                        if (state.important) stats.important++;
                        if (state.skip) stats.skipped++;
                        if (state.tags) {
                            state.tags.forEach(tag => {
                                stats.tags[tag] = (stats.tags[tag] || 0) + 1;
                            });
                        }
                    }
                });
            });
            
            return stats;
        }

        // Show statistics
        function showStats() {
            const stats = calculateStats();
            alert(`Review Statistics:\n\n` +
                  `Films: ${stats.totalFilms}\n` +
                  `Total Results: ${stats.totalResults}\n` +
                  `Reviewed: ${stats.reviewed} (${(stats.reviewed/stats.totalResults*100).toFixed(1)}%)\n` +
                  `Important: ${stats.important}\n` +
                  `Skipped: ${stats.skipped}\n\n` +
                  `Tags:\n${Object.entries(stats.tags).map(([tag, count]) => 
                      `  ${tag}: ${count}`).join('\n')}`);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.target.tagName === 'INPUT') return; // Don't trigger when typing
            
            switch(e.key) {
                case 'ArrowRight':
                case ' ':
                    e.preventDefault();
                    nextResult();
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    previousResult();
                    break;
                case 'r':
                    toggleReviewed();
                    break;
                case 'i':
                    toggleImportant();
                    break;
                case 's':
                    toggleSkip();
                    break;
                case 'u':
                    jumpToUnreviewed();
                    break;
            }
        });

        // Load sample data for testing
        function loadSampleData() {
            currentData = [{
                film: { title: "The Wizard of Oz", year: "1939" },
                totalFound: 47,
                treasures: [{
                    id: "variety137-1940-01_0054",
                    publication: "variety",
                    date: "1940-01-03",
                    finalScore: 95.5,
                    excerpt: "THE WIZARD OF OZ (MUSICAL) Excellent fantasy. M-G-M's spectacular fantasy musical emerges as an outstanding entertainment achievement...",
                    fullText: "Full text would be here...",
                    readUrl: "http://archive.org/stream/variety137-1940-01#page/n53/"
                }]
            }];
            initializeInterface();
        }
    </script>
</body>
</html>